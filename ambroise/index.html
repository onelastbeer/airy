<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compayible" content="ie=edge">
  <title>AIRY</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" rel="stylesheet">
</head>

<body>
  <div class="container">
    <table class="u-full-width">
      <thead>
        <tr>
          <th>Curency</th>
          <th>Quantity</th>
          <th>Original Rate [€]</th>
          <th>Current Rate [€]</th>
          <th>Original Value [€]</th>
          <th>Current Value [€]</th>
          <th>Profit/Loss [€]</th>
          <th>Profit/Loss [%]</th>
        </tr>
      </thead>
      <tbody>
        <tr id="btc">
        </tr>
        <tr id="eth">
        </tr>
        <tr id="bat">
        </tr>
        <tr id="ans">
        </tr>
        <tr id="pay">
        </tr>
        <tr id="nvo">
        </tr>
      </tbody>
    </table>

    <h1 style="text-align: center" id="total"></h1>
    <h4 style="text-align: center" id="investment"></h4>
  </div>

  <div style="bottom: 0px; text-align: right; width: 95%;">
      <a href="http://github.com/wakeupcoffee/amirichyet">code</a> |
      © Louis Merlin & Ambroise Mean
  </div>
  <script>
    var rates = {};
    var investment = 5000;

    var curs = {
      "btc": {
        "id": "bitcoin",
        "am": 0.00018,
        "or": 718.723921,
      },
      "eth": {
        "id": "ethereum",
        "am": 0.00018,
        "or": 718.723921,
      },
      "bat": {
        "id": "basic-attention-token",
        "am": 0.00018,
        "or": 718.723921,
      },
      "ans": {
        "id": "antshares",
        "am": 0.00018,
        "or": 718.723921,
      },
      "pay": {
        "id": "tenx",
        "am": 0.00018,
        "or": 718.723921,
      }
    }

    var amounts = {
      "btc": 0.00018,
      "eth": 2.11,
      "nvo": 0,
      "bat": 19416.835,
      "ans": 2000,
      "pay": 13440
    };
    var originalRates = {
      "btc": 718.723921,
      "eth": 12.5007618,
      "nvo": 133.5000,
      "bat": 0.19541556559,
      "ans": 4.27597300827,
      "pay": 0.704
    };
    var originalValues = {
      "btc": amounts["btc"] * originalRates["btc"],
      "eth": amounts["eth"] * originalRates["eth"],
      "nvo": amounts["nvo"] * originalRates["nvo"],
      "bat": amounts["bat"] * originalRates["bat"],
      "pay": amounts["pay"] * originalRates["pay"],
      "ans": amounts["ans"] * originalRates["ans"]
    }
    var totalOriginalValue = 0;

    function countProperties(obj) {
      var count = 0;

      for(var prop in obj) {
          if(obj.hasOwnProperty(prop))
              ++count;
        }

        return count;
    }

    var nbCurrencies = countProperties(curs);

    for (var currency in curs) {
      curs[currency].ov = curs[currency].or * curs[currency].am
      if (originalValues.hasOwnProperty(currency)) {
        totalOriginalValue += curs[currency].ov;
      }
    }

    getRate = function(cur) {
      var req = new XMLHttpRequest();
      req.open('GET', 'https://api.coinmarketcap.com/v1/ticker/' + cur.id + '/?convert=EUR', true);
      req.onload = function() {
        if (this.status >= 200 && this.status < 400) {
          var data = JSON.parse(this.response);
          if(data.success) cur.cr = data.ticker.price;
          else cur.cr = -1;
        } else {
          console.log("We reached our target server, but it returned an error");
          rates[pair] = -1;
        }
      };
      req.onerror = function() {
        console.log("There was a connection error of some sort");
        rates[pair] = -1;
      };
      req.send();
    }

    getRates = function() {
      for(var key in curs) {
        getRate(curs[key]);
      }
    }

    getRates();
    fillIn = function() {
      sum = 0;
      done = 0;
      Object.keys(rates).forEach(function(k) {
        var oriWorth = curs[k].or * curs[k].am;
        var curWorth = curs[k].cr * curs[k].am;
        var won = (curWorth)-(oriWorth);
        var perWon = won/oriWorth*100;

        var amountStr = curs[k].am.toString().slice(0, 6);
        var oriRatesStr = curs[k].or.toString().slice(0, 6);
        var ratesStr = curs[k].cr.toString().slice(0, 6);
        var oriWorthStr = oriWorth.toFixed(2).toString();
        var curWorthStr = curWorth.toFixed(2).toString();
        var wonStr = won.toFixed(2).toString();
        var perWonStr = perWon.toFixed(2).toString();

        if(rates[k] < 0) {
          curWorth = oriWorth;
          curWorthStr = "Error";
          ratesStr = "Error"
          wonStr = "Error";
          perWonStr = "Error";
        }

        document.getElementById(k).innerHTML =
          "<td>" + k.toUpperCase() + "</td>" +
          "<td>" + amountStr + "</td>" +
          "<td>" + oriRatesStr + "</td>" +
          "<td>" + ratesStr + "</td>" +
          "<td>" + oriWorthStr + "</td>" +
          "<td>" + curWorthStr + "</td>" +
          "<td>" + wonStr + "</td>" +
          "<td style=\"color:" + (won >= 0 ? "green" : "red") + "\">"
          + (amounts[k] >  0 ? perWonStr : "0") + (rates[k] >= 0 ? "%" : "") + "</td>";
        sum += curs[k].cr * curs[k].am;
        if (rates[k] > 0) done++
      });
      var totalWorth = sum;
      sum -= investment;
      sum = parseFloat(Math.round(sum * 100) / 100);
      if (sum > 0) {
        document.title = "+ " + sum.toFixed(0) + "€";
        document.getElementById("total").innerHTML = "+ "  + sum.toFixed(0) + "€" + " | " + (sum/investment*100).toFixed(0).toString() + "%";
        document.getElementById("total").style.color = 'green';
      } else {
        document.title = "- " + (-sum).toFixed(0) + "€";
        document.getElementById("total").innerHTML = "- " + (-sum).toFixed(0) + "€" + " | " + (-sum/investment*100).toFixed(0).toString() + "%";
        document.getElementById("total").style.color = 'red';
      };
      document.getElementById("investment").innerHTML = "Total investment : "
      + investment.toFixed(0).toString() + "€ | Current worth : "
      + totalWorth.toFixed(0).toString() + "€";
      if (done < nbCurrencies) setTimeout(fillIn, 50);
      else setTimeout(function() {
        getRates();
        fillIn();
      }, 10000);
    }
    fillIn();
  </script>
</body>

</html>
